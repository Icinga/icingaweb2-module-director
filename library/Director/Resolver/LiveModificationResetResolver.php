<?php

namespace Icinga\Module\Director\Resolver;

use Icinga\Module\Director\Db;
use Icinga\Module\Director\DirectorObject\IcingaModifiedAttribute;
use Icinga\Module\Director\DirectorObject\IcingaObjectModifications;
use Icinga\Module\Director\Objects\IcingaHost;
use Icinga\Module\Director\Objects\IcingaObject;
use Icinga\Module\Director\Objects\IcingaService;

class LiveModificationResetResolver
{
    protected $db;

    public function __construct(Db $db)
    {
        $this->db = $db;
    }

    /**
     * @param IcingaModifiedAttribute[] $modifiedAttributes
     * @return IcingaObjectModifications[]
     */
    public function cleanModifications(array $modifiedAttributes)
    {
        $modifications = [];
        foreach ($modifiedAttributes as $modification) {
            if ($modification->get('action') === 'delete' || $modification->get('state') !== 'applied') {
                continue;
            }
            $key = $modification->getUniqueKey();
            if (!isset($modifications[$key])) {
                $modifications[$key] = new IcingaObjectModifications(
                    $modification->get('icinga_object_type'),
                    $modification->get('icinga_object_name')
                );
            }
            $modifications[$key]->addModification($modification);
        }

        return $modifications;
    }

    /**
     * @return IcingaModifiedAttribute[]
     */
    public function fetchAppliedModificationsBeforeAndIncludingActivityId($id)
    {
        return IcingaModifiedAttribute::loadAll(
            $this->db,
            $this->db->getDbAdapter()->select()->from('icinga_modified_attribute')
                ->where('activity_id <= ?', $id)
                ->orWhere('activity_id IS NULL')
                ->order('id')
        );
    }

    /**
     * @param IcingaModifiedAttribute[] $modifiedAttributes
     * @throws \Icinga\Exception\NotFoundError
     * @throws \Icinga\Module\Director\Exception\DuplicateKeyException
     */
    public function scheduleAttributesToBeReset(array $modifiedAttributes)
    {
        $cleanupModifications = [];
        $performedModifications = $this->cleanModifications($modifiedAttributes);
        foreach ($performedModifications as $modification) {
            $object = null;
            switch ($modification->objectType) {
                case 'Host':
                    try {
                        $object = IcingaHost::load($modification->objectName, $this->db);
                    } catch (\Exception $e) {
                        break;
                    }

                    $dummy = IcingaObject::createByType('host', [
                        'object_name' => $object->get('object_name'),
                    ], $this->db);
                    break;
                case 'Service':
                    $icingaServiceName = explode('!', $modification->objectName);
                    try {
                        $host = IcingaHost::load($icingaServiceName[0], $this->db);
                        $object = IcingaService::load([
                            'object_name' => $icingaServiceName[1],
                            'host_id'     => $host->get('id')
                        ], $this->db);
                    } catch (\Exception $e) {
                        // A service associated with a host but generated by a host template
                        // cannot be loaded from the DB, so for this reason the exception is ignored
                        break;
                    }

                    $dummy = IcingaService::createByType('service', [
                        'object_name' => $object->getObjectName(),
                        'host_id'     => $object->get('host_id')
                    ], $this->db);
                    break;

                default:
                    throw new \RuntimeException(sprintf(
                        'Resetting attribute for %s is not supported',
                        $modification->objectType
                    ));
            }

            // to handle the case when and object is created and deleted with live modification
            // before a manual deploy
            if (!isset($object)) {
                continue;
            }

            /** @var IcingaObject $object */
            foreach ($modification->modifications as $key => $value) {
                $currentValue = $object->getResolvedProperty($key);
                if ($currentValue !== $value) {
                    $dummy->set($key, $currentValue);
                }
            }
            if (count($dummy->getModifiedProperties())) {
                // TODO: api props only -> toApiObject -> remove object_name
                $attribute = IcingaModifiedAttribute::prepareIcingaModifiedAttributeForSingleObject($dummy);
                $attribute->set('state', 'scheduled_for_reset');
                $attribute->set('action', 'modify');
                $cleanupModifications[] = $attribute;
            }
        }

        foreach ($cleanupModifications as $modification) {
            $modification->store($this->db);
        }
    }
}
